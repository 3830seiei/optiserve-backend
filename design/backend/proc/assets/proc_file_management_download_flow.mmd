graph TD
    A[医療機関：レポートダウンロード] --> B[レポート公開情報取得]
    B --> C[ファイル存在チェック]
    C --> D{初回ダウンロード？}
    D -->|Yes| E[ダウンロード履歴記録]
    D -->|No| F[既存履歴確認]
    E --> G[MIMEタイプ設定]
    F --> G
    G --> H[ファイル配信（FileResponse）]
    
    B -->|レポートなし| I[404 Not Found]
    C -->|ファイルなし| J[404 Not Found]