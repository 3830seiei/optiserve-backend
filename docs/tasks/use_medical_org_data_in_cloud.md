# クラウド側で厚生労働省の医療機関情報を利用する仕組み

## 📘 概要

本ドキュメントでは、オンプレミス側に保有する厚生労働省提供の「医療機関マスタ情報」を、必要なものだけを選別して **AWS（クラウド）側に部分同期**し、システムで利用可能とする現実的な構成について説明します。

---

## ✅ 目的と課題

| 項目 | 内容 |
|------|------|
| 🎯 目的 | OptiServe等のクラウドシステムから、必要な医療機関情報のみを検索・表示・登録時補助などに利用 |
| ⚠️ 課題 | 医療機関数が約10万件を超えるため、すべてをクラウドに保持するのは非効率かつストレージが無駄 |

---

## 🧩 提案構成（部分同期方式）

```
オンプレ                                  AWS
┌─────────────────────┐            ┌────────────────────┐
│ master_medical_orgs （全医療機関）│──┐         ┌──▶│ master_medical_orgs (部分コピー) │
└─────────────────────┘  │         │   └────────────────────┘
                          ▼         ▼
┌─────────────────────┐   定期同期   ┌────────────────────┐
│ sync_target_orgs (同期対象リスト) │────────▶│ S3/DB/YAML or DynamoDB         │
└─────────────────────┘              └────────────────────┘
```

---

## 🔧 各構成要素の詳細

### オンプレ側

- `master_medical_orgs`  
  - 厚労省の全医療機関マスタ
  - CSVインポート or バッチ取得で更新

- `sync_target_orgs`  
  - 同期対象となる医療機関IDのリスト
  - 手動 or GUI or YAMLで追加可能
  - 例：

    ```sql
    CREATE TABLE sync_target_orgs (
        medical_id INTEGER PRIMARY KEY,
        note TEXT
    );
    ```

### AWS側

- `master_medical_orgs`（部分同期）  
  - フロントエンドでの入力補助、検索用
  - 同期対象リストに含まれるIDだけを保管

---

## 🔁 同期方式

### ⏰ バッチ方式（おすすめ）

- cron or AWS Batchで、日次 or 定期的に実行
- 差分だけを検出して `upsert`（更新または挿入）

### 🧪 オプション：YAMLやCSVでの管理も可能

```yaml
sync_targets:
  - medical_id: 123456
    note: "導入予定医療機関A"
  - medical_id: 789012
    note: "別システム移行中"
```

---

## 🛠️ 同期ロジック（例）

1. `sync_target_orgs` から ID一覧を取得  
2. `master_medical_orgs` から該当するレコードを抽出  
3. PostgreSQL側へ `UPSERT`（INSERT or UPDATE）  

Pythonでの簡易例（psycopg2, SQLAlchemy, etc.）も別途提供可能。

---

## ✨ メリット

| 項目 | 内容 |
|------|------|
| 🧠 賢く同期 | 必要な医療機関だけ同期するのでストレージ効率良 |
| 🔐 情報制限 | 厚労省の全データをクラウドに置かないのでセキュア |
| 🔁 拡張可能 | 他のマスタにも応用可能（例：製品マスタ等） |
| 🔧 保守容易 | `sync_target_orgs` を編集するだけで反映可能 |

---

## ⚠️ 注意点

- 同期は定期的な実行を保証する仕組みが必要（cron or workflow）  
- オンプレ側のマスタ更新に追従するための定期更新も必要  
- 「上書き禁止（クラウドで修正される情報）」などの排他制御が必要な場合は同期ロジックを工夫  

---

## 📂 今後のタスク例

- [ ] `sync_target_orgs` テーブルの導入とメンテナンス運用方針
- [ ] 初期同期バッチ（PythonまたはShell）
- [ ] クラウド側 `master_medical_orgs` テーブル作成
- [ ] GUI or YAMLベースの同期対象選択ツールの検討

---

## 🏁 まとめ

この「部分同期」構成により、**不要なクラウド転送を防ぎつつ、必要な医療機関情報のみを素早く利用**できます。将来的には、他の業務マスタにも応用可能で、シンプルかつ実運用に耐える設計です。

今後のタスクフォルダにこの設計ドキュメントを保管し、順次実装・評価を進めてください。
