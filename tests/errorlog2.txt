((.venv) ) smds@aoi-ph-017:~/projects/optiserve-backend/data/onpre_reports/5/2025/05$ ls
hpreport-05_20250804.pptx
((.venv) ) smds@aoi-ph-017:~/projects/optiserve-backend/data/onpre_reports/5/2025/05$ cd
((.venv) ) smds@aoi-ph-017:~$ cd projects/optiserve-backend
((.venv) ) smds@aoi-ph-017:~/projects/optiserve-backend$ python -c "from src.utils.path_config import path_config; print(path_config.get_config_info())"
{'system': 'linux', 'base_path': '/home/smds/projects/optiserve-backend', 'database_path': '/home/smds/projects/optiserve-backend', 'files_base_path': '/home/smds/projects/optiserve-backend/files', 'uploads_path': '/home/smds/projects/optiserve-backend/files/uploads', 'reports_path': '/home/smds/projects/optiserve-backend/files/reports', 'data_path': '/home/smds/projects/optiserve-backend/data', 'onpre_reports_path': '/home/smds/projects/optiserve-backend/data/onpre_reports', 'database_url': 'sqlite:////home/smds/projects/optiserve-backend/poc_optigate.db'}

((.venv) ) smds@aoi-ph-017:~/projects/optiserve-backend$ pytest tests/test_05_file_management_api.py -v -s
================================================== test session starts ==================================================
platform linux -- Python 3.12.11, pytest-8.4.1, pluggy-1.6.0 -- /home/smds/projects/optiserve-backend/.venv/bin/python
cachedir: .pytest_cache
rootdir: /home/smds/projects/optiserve-backend
plugins: anyio-4.9.0
collected 19 items

tests/test_05_file_management_api.py::test_api_server_is_running âœ… APIã‚µãƒ¼ãƒãƒ¼ç¨¼åƒç¢ºèªå®Œäº†
PASSED
tests/test_05_file_management_api.py::test_file_upload_success ãƒ¬ã‚¹ãƒãƒ³ã‚¹: status_code=200
âœ… ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æˆåŠŸ: medical_id=6, å®Ÿè¡Œæœˆ=2025-08
   ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«æ•°: 3ä»¶
PASSED
tests/test_05_file_management_api.py::test_file_upload_nonexistent_medical_id âœ… å­˜åœ¨ã—ãªã„åŒ»ç™‚æ©Ÿé–¢IDã‚¨ãƒ©ãƒ¼: åŒ»ç™‚æ©Ÿé–¢IDï¼ˆmedical_idï¼‰ 99999 ã¯å­˜åœ¨ã—ã¾ã›ã‚“
PASSED
tests/test_05_file_management_api.py::test_file_upload_wrong_file_extension âœ… ç„¡åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«æ‹¡å¼µå­ã‚¨ãƒ©ãƒ¼: åŒ»ç™‚æ©Ÿå™¨å°å¸³ãƒ•ã‚¡ã‚¤ãƒ«ã¯CSVå½¢å¼ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
PASSED
tests/test_05_file_management_api.py::test_file_upload_missing_file âœ… ãƒ•ã‚¡ã‚¤ãƒ«ä¸è¶³ã‚¨ãƒ©ãƒ¼ç¢ºèªå®Œäº†
PASSED
tests/test_05_file_management_api.py::test_file_upload_overwrite âœ… 1å›žç›®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æˆåŠŸ: 3ä»¶
âœ… ä¸Šæ›¸ãã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æˆåŠŸ: 1å›žç›®=2025-08-28T18:37:59, 2å›žç›®=2025-08-28T18:37:59
PASSED
tests/test_05_file_management_api.py::test_upload_status_endpoint âœ… ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰çŠ¶æ³å–å¾—æˆåŠŸ: 0ä»¶ã®çŠ¶æ³ãƒ‡ãƒ¼ã‚¿
PASSED
tests/test_05_file_management_api.py::test_available_reports_endpoint âœ… åˆ©ç”¨å¯èƒ½ãƒ¬ãƒãƒ¼ãƒˆå–å¾—æˆåŠŸ: 0ä»¶ã®ãƒ¬ãƒãƒ¼ãƒˆ
PASSED
tests/test_05_file_management_api.py::test_system_file_download_success âœ… ãƒ†ã‚¹ãƒˆç”¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†
âœ… ã‚·ã‚¹ãƒ†ãƒ ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æˆåŠŸ: equipment.csv (ãƒ•ã‚¡ã‚¤ãƒ«ç¨®åˆ¥=1)
âœ… ã‚·ã‚¹ãƒ†ãƒ ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æˆåŠŸ: rental.csv (ãƒ•ã‚¡ã‚¤ãƒ«ç¨®åˆ¥=2)
âœ… ã‚·ã‚¹ãƒ†ãƒ ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æˆåŠŸ: failure.csv (ãƒ•ã‚¡ã‚¤ãƒ«ç¨®åˆ¥=3)
PASSED
tests/test_05_file_management_api.py::test_system_file_download_unauthorized âœ… èªè¨¼ã‚¨ãƒ©ãƒ¼ãƒ†ã‚¹ãƒˆæˆåŠŸ: APIã‚­ãƒ¼ãªã—ã§401ã‚¨ ãƒ©ãƒ¼
âœ… èªè¨¼ã‚¨ãƒ©ãƒ¼ãƒ†ã‚¹ãƒˆæˆåŠŸ: é–“é•ã£ãŸAPIã‚­ãƒ¼ã§401ã‚¨ãƒ©ãƒ¼
PASSED
tests/test_05_file_management_api.py::test_system_file_download_file_not_found âœ… ãƒ•ã‚¡ã‚¤ãƒ«æœªå­˜åœ¨ãƒ†ã‚¹ãƒˆæˆåŠŸ: å­˜åœ¨ã—ãªã„åŒ» ç™‚æ©Ÿé–¢IDã§404ã‚¨ãƒ©ãƒ¼
PASSED
tests/test_05_file_management_api.py::test_system_file_download_invalid_file_type âœ… ç„¡åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«ç¨®åˆ¥ãƒ†ã‚¹ãƒˆæˆåŠŸ: ãƒ•ã‚¡ã‚¤ãƒ«ç¨®åˆ¥99ã§400ã‚¨ãƒ©ãƒ¼
PASSED
tests/test_05_file_management_api.py::test_publish_reports_unauthorized âœ… ãƒ¬ãƒãƒ¼ãƒˆå…¬é–‹èªè¨¼ã‚¨ãƒ©ãƒ¼ãƒ†ã‚¹ãƒˆæˆåŠŸ: APIã‚­ãƒ¼ãªã— ã§401ã‚¨ãƒ©ãƒ¼
âœ… ãƒ¬ãƒãƒ¼ãƒˆå…¬é–‹èªè¨¼ã‚¨ãƒ©ãƒ¼ãƒ†ã‚¹ãƒˆæˆåŠŸ: é–“é•ã£ãŸAPIã‚­ãƒ¼ã§401ã‚¨ãƒ©ãƒ¼
PASSED
tests/test_05_file_management_api.py::test_publish_reports_with_auth âœ… ãƒ¬ãƒãƒ¼ãƒˆå…¬é–‹èªè¨¼æˆåŠŸãƒ†ã‚¹ãƒˆå®Œäº†: èªè¨¼é€šéŽå¾Œã«404ã‚¨ãƒ©ãƒ¼ï¼ˆã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ãƒ¬ãƒãƒ¼ãƒˆæœªå­˜åœ¨ï¼‰
PASSED
tests/test_05_file_management_api.py::test_publish_onpremise_reports âŒ ã‚¨ãƒ©ãƒ¼è©³ç´°: 404, {"detail":"ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ãƒ¬ãƒãƒ¼ãƒˆ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: åŒ»ç™‚æ©Ÿé–¢ID=5, å¹´æœˆ=2025-05"}
FAILED
tests/test_05_file_management_api.py::test_publish_nonexistent_onpremise_reports âœ… å­˜åœ¨ã—ãªã„åŒ»ç™‚æ©Ÿé–¢IDã§ãƒ¬ãƒãƒ¼ãƒˆå…¬é–‹ã‚¨ ãƒ©ãƒ¼ãƒ†ã‚¹ãƒˆæˆåŠŸ
PASSED
tests/test_05_file_management_api.py::test_report_download_after_publish âš ï¸ ãƒ¬ãƒãƒ¼ãƒˆå…¬é–‹çµæžœ: 404 (æ—¢ã«å…¬é–‹æ¸ˆã¿ã®å¯èƒ½æ€§)
ðŸ“‹ å–å¾—ã—ãŸpublication_id: 8
ðŸ“Š ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å‰çŠ¶æ…‹: download_user_id=10, download_datetime=2025-08-28 17:14:00.442110
FAILED
tests/test_05_file_management_api.py::test_report_download_nonexistent_publication âœ… å­˜åœ¨ã—ãªã„publication_IDã§ãƒ€ã‚¦ãƒ³ãƒ­ ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼ãƒ†ã‚¹ãƒˆæˆåŠŸ
PASSED
tests/test_05_file_management_api.py::test_report_download_multiple_times FAILED

======================================================= FAILURES ========================================================
____________________________________________ test_publish_onpremise_reports _____________________________________________

    def test_publish_onpremise_reports():
        """ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ãƒ¬ãƒãƒ¼ãƒˆå…¬é–‹ãƒ†ã‚¹ãƒˆï¼ˆhpcode=5ã€2025-05æœˆåˆ†ï¼‰"""
        medical_id = 5
        publication_ym = "2025-05"
        system_key = "optiserve-internal-system-key-2025"

        data = {
            'publication_ym': publication_ym
        }
        headers = {"X-System-Key": system_key}

        publish_res = requests.post(
            f"{BASE_URL}/files/reports/publish/{medical_id}",
            data=data,
            headers=headers
        )

        if publish_res.status_code != 200:
            print(f"âŒ ã‚¨ãƒ©ãƒ¼è©³ç´°: {publish_res.status_code}, {publish_res.text}")
>       assert publish_res.status_code == 200
E       assert 404 == 200
E        +  where 404 = <Response [404]>.status_code

tests/test_05_file_management_api.py:552: AssertionError
__________________________________________ test_report_download_after_publish ___________________________________________

    def test_report_download_after_publish():
        """ãƒ¬ãƒãƒ¼ãƒˆå…¬é–‹å¾Œã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆï¼ˆuser_id=10ï¼‰"""
        medical_id = 5
        publication_ym = "2025-05"
        system_key = "optiserve-internal-system-key-2025"
        download_user_id = "10"

        # Step 1: ãƒ¬ãƒãƒ¼ãƒˆã‚’å…¬é–‹ï¼ˆã¾ãšå…¬é–‹ã•ã‚ŒãŸãƒ¬ãƒãƒ¼ãƒˆã®publication_idã‚’å–å¾—ï¼‰
        data = {
            'publication_ym': publication_ym
        }
        headers = {"X-System-Key": system_key}

        publish_res = requests.post(
            f"{BASE_URL}/files/reports/publish/{medical_id}",
            data=data,
            headers=headers
        )

        if publish_res.status_code != 200:
            # æ—¢ã«å…¬é–‹æ¸ˆã¿ã®å ´åˆã¯å•é¡Œãªã—
            print(f"âš ï¸ ãƒ¬ãƒãƒ¼ãƒˆå…¬é–‹çµæžœ: {publish_res.status_code} (æ—¢ã«å…¬é–‹æ¸ˆã¿ã®å¯èƒ½æ€§)")
        else:
            publish_data = publish_res.json()
            print(f"âœ… ãƒ¬ãƒãƒ¼ãƒˆå…¬é–‹æˆåŠŸ: {len(publish_data['published_reports'])}ä»¶")

        # Step 2: DBã‹ã‚‰æœ€æ–°ã®publication_idã‚’å–å¾—ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œ
        from src.database import SessionLocal
        from src.models.pg_optigate.report_publication_log import ReportPublicationLog

        db = SessionLocal()
        try:
            # å¯¾è±¡åŒ»ç™‚æ©Ÿé–¢ãƒ»å¹´æœˆã®æœ€æ–°ãƒ¬ãƒãƒ¼ãƒˆã‚’å–å¾—
            latest_report = db.query(ReportPublicationLog).filter(
                ReportPublicationLog.medical_id == medical_id,
                ReportPublicationLog.publication_ym == publication_ym
            ).order_by(ReportPublicationLog.upload_datetime.desc()).first()

            if not latest_report:
                raise Exception(f"å…¬é–‹ã•ã‚ŒãŸãƒ¬ãƒãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: åŒ»ç™‚æ©Ÿé–¢ID={medical_id}, å¹´æœˆ={publication_ym}")

            publication_id = latest_report.publication_id
            print(f"ðŸ“‹ å–å¾—ã—ãŸpublication_id: {publication_id}")

            # ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å‰ã®DBçŠ¶æ…‹ã‚’è¨˜éŒ²
            download_datetime_before = latest_report.download_datetime
            download_user_id_before = latest_report.download_user_id
            print(f"ðŸ“Š ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å‰çŠ¶æ…‹: download_user_id={download_user_id_before}, download_datetime={download_datetime_before}")

        finally:
            db.close()

        # Step 3: ãƒ¬ãƒãƒ¼ãƒˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œ
        download_res = requests.get(
            f"{BASE_URL}/files/reports/download/{publication_id}",
            params={"user_id": download_user_id},
            headers=TEST_HEADERS
        )

>       assert download_res.status_code == 200
E       assert 404 == 200
E        +  where 404 = <Response [404]>.status_code

tests/test_05_file_management_api.py:662: AssertionError
__________________________________________ test_report_download_multiple_times __________________________________________

    def test_report_download_multiple_times():
        """åŒä¸€ãƒ¬ãƒãƒ¼ãƒˆã®è¤‡æ•°å›žãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆï¼ˆDBæ›´æ–°ã¯åˆå›žã®ã¿ï¼‰"""
        medical_id = 5
        publication_ym = "2025-05"
        user_id_1 = "10"
        user_id_2 = "1"  # ç•°ãªã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼

        # æœ€æ–°ãƒ¬ãƒãƒ¼ãƒˆã®publication_idã‚’å–å¾—
        from src.database import SessionLocal
        from src.models.pg_optigate.report_publication_log import ReportPublicationLog

        db = SessionLocal()
        try:
            latest_report = db.query(ReportPublicationLog).filter(
                ReportPublicationLog.medical_id == medical_id,
                ReportPublicationLog.publication_ym == publication_ym
            ).order_by(ReportPublicationLog.upload_datetime.desc()).first()

            if not latest_report:
                print("âš ï¸ ãƒ†ã‚¹ãƒˆç”¨ãƒ¬ãƒãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å…ˆã«test_report_download_after_publishã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„")
                return

            publication_id = latest_report.publication_id

            # 1å›žç›®ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆæ—¢ã«å®Ÿè¡Œæ¸ˆã¿ã®æƒ³å®šï¼‰
            first_download_user_id = latest_report.download_user_id
            first_download_datetime = latest_report.download_datetime

        finally:
            db.close()

        # 2å›žç›®ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆåˆ¥ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰
        download_res = requests.get(
            f"{BASE_URL}/files/reports/download/{publication_id}",
            params={"user_id": user_id_2},
            headers=TEST_HEADERS
        )

>       assert download_res.status_code == 200
E       assert 404 == 200
E        +  where 404 = <Response [404]>.status_code

tests/test_05_file_management_api.py:743: AssertionError
================================================ short test summary info ================================================
FAILED tests/test_05_file_management_api.py::test_publish_onpremise_reports - assert 404 == 200
FAILED tests/test_05_file_management_api.py::test_report_download_after_publish - assert 404 == 200
FAILED tests/test_05_file_management_api.py::test_report_download_multiple_times - assert 404 == 200
============================================= 3 failed, 16 passed in 0.82s ==============================================
((.venv) ) smds@aoi-ph-017:~/projects/optiserve-backend$
